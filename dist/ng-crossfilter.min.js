/*! ng-crossfilter by Adam Timberlake <adam.timberlake@gmail.com> created on 2015-11-12 */
!function(a,b,c,d){"use strict";var e=function(a){throw"ngCrossfilter: "+a+"."};"undefined"==typeof a&&e("ngCrossfilter Requires Angular.js"),"undefined"==typeof b&&e("ngCrossfilter Requires Crossfilter");var f="undefined"!=typeof d,g=function(a){return"function"==typeof Array.isArray?Array.isArray(a):"undefined"!=typeof d?d.isArray(a):"[object Array]"==typeof a},h={HAS_UNDERSCORE:f,fuzzy:function(a){return function(b,c){var d=new RegExp(b,a);return!!c.match(d)}},dateTimeRange:function(a,b){return"undefined"==typeof c&&e("You need to install Moment.js to use dateTimeRange"),function(d,f){var g=d[0]===-(1/0)?0:c(d[0],a).unix(),h=d[1]===1/0?1/0:c(d[1],a).unix(),i=c(f,a).unix();return(0>g||0>h||0>i)&&e("Date/Time parsing appears to be using invalid format"),"function"==typeof b?b(i,g,h):i>=g&&h>=i}},regexp:function(){return function(a,b){return a instanceof RegExp||e("Expression must be an instance of RegExp"),!!b.match(a)}},bitwise:function(a){return function(b,c){var d=b&c;return"!"===a?!d:d}},inArray:function(a){return this._inArray(a,!1)},notInArray:function(a){return this._inArray(a,!0)},_inArray:function(a,b){var c=f;return function(f,h){g(h)||(h=[h]),g(f)||(f=[f]),a=a||"every",a&&-1===["every","some"].indexOf(a)&&e("You must pass either 'every' or 'some'"),c||"function"==typeof[].every&&"function"==typeof[].some||e("Browser does not support `every` and/or `some` methods");var i=function(a){var c=-1!==h.indexOf(a);return b?!c:c};return c?d[a](f,i):f[a](i)}}},i=a.module("ngCrossfilter",[]);i.service("Crossfilter",["$rootScope",function(c){var i=function(a,b,c,d){a=a||[],this._resetAll(),this._initialise(a,b,c,d)};return i.filters=h,i.prototype=[],i.prototype.STRATEGY_PERSISTENT="persistent",i.prototype.STRATEGY_TRANSIENT="transient",i.prototype.PRIMARY_DIMENSION="__primaryKey",i.prototype.PRIMARY_SPECIAL="$id",i.prototype.HAS_UNDERSCORE=f,i.prototype._crossfilter={},i.prototype._cacheGroups={},i.prototype._specialId=1,i.prototype._dimensions={},i.prototype._primaryKey="",i.prototype._sortProperty="",i.prototype._isAscending=!0,i.prototype._lastFilter="",i.prototype._strategy="",i.prototype._deletedKeys=[],i.prototype._identifier="",i.prototype._isBroadcastEventEnabled=!0,i.prototype.filters=h,i.prototype._isArray=g,i.prototype._initialise=function(c,d,f,h){if(g(c)||e("Collection must be an array"),f=f||this.STRATEGY_PERSISTENT,-1===[this.STRATEGY_PERSISTENT,this.STRATEGY_TRANSIENT].indexOf(f)&&e("Strategy must be either '"+this.STRATEGY_PERSISTENT+"' or '"+this.STRATEGY_TRANSIENT+"'"),d&&h&&-1===h.indexOf(d)&&e("Primary key '"+d+"' as one of the dimensions"),c[0]){var i=!(d in c[0]);c.length&&d&&i&&d!==this.PRIMARY_SPECIAL&&e("Primary key '"+d+"' is not in the collection")}d===this.PRIMARY_SPECIAL&&a.forEach(c,function(a){a[this.PRIMARY_SPECIAL]=++this._specialId}.bind(this)),h=h||this._getProperties(c[0]),this._crossfilter=b(c),this._strategy=f,this._primaryKey=d||h[0]||"",this._defineDimensions(h),this._primaryKey&&this.primaryKey(this._primaryKey),this.broadcastEvent()},i.prototype._defineDimensions=function(b){a.forEach(b,function(a){this.addDimension(a,null,!0)}.bind(this))},i.prototype.primaryKey=function(a){this._primaryKey=a,this.addDimension(this.PRIMARY_DIMENSION,function(b){return b[a]}.bind(this),!0)},i.prototype.filterBy=function(a,b,c){if(this._cacheGroups={},this._assertDimensionExists(a),"undefined"!=typeof c&&"function"!=typeof c)throw e("Custom filter method must be a function");return this._lastFilter&&this._strategy===this.STRATEGY_TRANSIENT&&this.unfilterBy(this._lastFilter),this._lastFilter=a,"function"==typeof c?(this._dimensions[a].filterFunction(function(a){return c(b,a)}),void this.broadcastEvent()):(this._dimensions[a].filter(b),void this.broadcastEvent())},i.prototype.unfilterBy=function(a){this._cacheGroups={},this._assertDimensionExists(a),this._dimensions[a].filterAll(),this.broadcastEvent()},i.prototype.unfilterAll=function(){this._cacheGroups={};for(var a in this._dimensions)this._dimensions.hasOwnProperty(a)&&this._dimensions[a].filterAll();this.broadcastEvent()},i.prototype.sortBy=function(a,b){if(this._assertDimensionExists(a),"boolean"==typeof b)return this._isAscending=b,void(this._sortProperty=a);var c=this._sortProperty||this._primaryKey;c===a&&(this._isAscending=!this._isAscending),this._sortProperty=a,this.broadcastEvent()},i.prototype.unsortAll=function(a){this._sortProperty=this._primaryKey,a!==!0&&(this._isAscending=!0),this.broadcastEvent()},i.prototype.addDimension=function(a,b,c){b=b||function(b){return b[a]},c||this._assertValidDimensionName(a),this._dimensions[a]=this._crossfilter.dimension(b)},i.prototype.deleteDimension=function(a){this._assertDimensionExists(a),this._dimensions[a].dispose(),delete this._dimensions[a]},i.prototype.first=function(){return this.collection()[0]},i.prototype.last=function(){return this.collection()[this.collection().length-1]},i.prototype.countBy=function(a,b){if(this._cacheGroups[a])return this._cacheGroups[a][b]||0;this._assertDimensionExists(a);var c={},d=this._dimensions[a].group().all();for(var e in d)if(d.hasOwnProperty(e)){var f=d[e];c[f.key]=f.value}return this._cacheGroups[a]=c,c[b]||0},i.prototype.groupBy=function(a,b){if(this._assertDimensionExists(a),"undefined"==typeof b)return this._dimensions[a].group(function(a){return a}).all();"object"!=typeof b&&e("Custom reducer must be an object");var c=b.add||function(a){return a+1},d=b.remove||function(a){return a-1},f=b.initial||function(){return 0};return("function"!=typeof c||"function"!=typeof d||"function"!=typeof f)&&e("Custom reducer's `add`, `remove`, and `initial` properties must be functions"),this._dimensions[a].group(function(a){return a}).reduce(c,d,f).all()},i.prototype.models=function(a,b){var c=this.collection("number"==typeof b?b:1/0);return c.splice("number"==typeof a?a:1/0)},i.prototype.addModel=function(a){return this.addModels([a])},i.prototype.addModels=function(b){if(this._cacheGroups={},!this._primaryKey){var c=this.HAS_UNDERSCORE?d.keys:Object.keys;this.primaryKey(c(b[0])[0]);var e=!0;for(var f in this._dimensions)this._dimensions.hasOwnProperty(f)&&(e=!1);e||this._defineDimensions(this._getProperties(b[0]))}return this._primaryKey===this.PRIMARY_SPECIAL&&a.forEach(b,function(a){a[this.PRIMARY_SPECIAL]=++this._specialId}.bind(this)),this._crossfilter.add(b),this.broadcastEvent(),b.length},i.prototype.updateModel=function(a,b){a.hasOwnProperty(this.PRIMARY_SPECIAL)||e("`updateModel` only works when PK is defined as `"+this.PRIMARY_SPECIAL+"`"),this.deleteModel(a);for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);a[this.PRIMARY_SPECIAL]=++this._specialId,this.addModel(a),this.broadcastEvent()},i.prototype.deleteModel=function(a){return this.deleteModels([a])},i.prototype.deleteModels=function(a){this._cacheGroups={};for(var b=this._getKeys(a),c=0;c<b.length;c++)c!==this.PRIMARY_DIMENSION&&this._deletedKeys.push(b[c]);return this._finaliseDeleteRestore(),this.broadcastEvent(),b.length},i.prototype.restoreModel=function(a){return this.restoreModels([a])},i.prototype.restoreModels=function(a){for(var b=this._getKeys(a),c=0;c<b.length;c++){var d=this._deletedKeys.indexOf(b[c]);this._deletedKeys.splice(d,1)}return this._finaliseDeleteRestore(),this.broadcastEvent(),b.length},i.prototype.broadcastEvent=function(a){(this._isBroadcastEventEnabled||a===!0)&&c.$broadcast("crossfilter/updated",this.collection(),this._identifier)},i.prototype.enableBroadcastEvent=function(){this._isBroadcastEventEnabled=!0},i.prototype.disableBroadcastEvent=function(){this._isBroadcastEventEnabled=!1},i.prototype.crossfilter=function(){return this._crossfilter},i.prototype.collection=function(a){var b=this._sortProperty||this.PRIMARY_DIMENSION,c=this._isAscending?"bottom":"top";return"undefined"==typeof this._dimensions[b]?this:this._dimensions[b][c](a||1/0)},i.prototype.identifyAs=function(a){this._identifier=a},i.prototype._finaliseDeleteRestore=function(){var a=this._deletedKeys;this._dimensions[this.PRIMARY_DIMENSION].filter(function(b){return-1===a.indexOf(b)})},i.prototype._assertDimensionExists=function(a){"undefined"==typeof this._dimensions[a]&&e("Unable to find dimension named '"+a+"'")},i.prototype._assertValidDimensionName=function(a){a===this.PRIMARY_DIMENSION&&e("Cannot define dimension using special dimension: '"+this.PRIMARY_DIMENSION+"'");for(var b in this._dimensions)b===a&&e("Cannot overwrite an existing dimension: '"+b+"'")},i.prototype._getProperties=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},i.prototype._getKeys=function(b){var c=[];return a.forEach(b,function(a){var b=a[this._primaryKey];"undefined"==typeof b&&e("Unable to find the primary key in model: '"+this._primaryKey+"'"),c.push(b)}.bind(this)),c},i.prototype._resetAll=function(){this._crossfilter={},this._cacheGroups={},this._deletedKeys=[],this._dimensions={}},i.prototype.toString=function(){return"[object Array]"},i}])}(window.angular,window.crossfilter,window.moment,window._);